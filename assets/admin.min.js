'use strict'; (function () { function $(selector) { return document.querySelector(selector); } function $all(selector) { return Array.prototype.slice.call(document.querySelectorAll(selector)); } var apiConfigured = false; function configureApiFetch() { if (apiConfigured) return; apiConfigured = true; if (typeof AVIFLocalSupportData === 'undefined') return; if (!window.wp || !wp.apiFetch) return; if (AVIFLocalSupportData.restUrl) { wp.apiFetch.use(wp.apiFetch.createRootURLMiddleware(AVIFLocalSupportData.restUrl)); } if (AVIFLocalSupportData.restNonce) { wp.apiFetch.use(wp.apiFetch.createNonceMiddleware(AVIFLocalSupportData.restNonce)); } } function apiFetch(options) { configureApiFetch(); if (!window.wp || !wp.apiFetch) { return Promise.reject(new Error('wp.apiFetch unavailable')); } return wp.apiFetch(options); } function getI18n(key, fallback) { if (typeof AVIFLocalSupportData === 'undefined' || !AVIFLocalSupportData.strings) return fallback; var value = AVIFLocalSupportData.strings[key]; if (typeof value !== 'string' || value === '') return fallback; return value; } function activateTab(id) { var tabs = ['settings', 'lqip', 'tools', 'about']; tabs.forEach(function (t) { var link = $('#avif-local-support-tab-link-' + t); var panel = $('#avif-local-support-tab-' + t); if (!link || !panel) return; if (t === id) { link.classList.add('nav-tab-active'); panel.classList.add('active'); } else { link.classList.remove('nav-tab-active'); panel.classList.remove('active'); } }); } function initTabs() { $all('.nav-tab-wrapper a').forEach(function (a) { a.addEventListener('click', function (e) { e.preventDefault(); var id = (this.getAttribute('href') || '').replace('#', ''); if (!id) return; activateTab(id); try { history.replaceState(null, '', '#' + id); } catch (e2) { } }); }); window.addEventListener('hashchange', function () { var id = (location.hash || '#settings').replace('#', ''); if (['settings', 'lqip', 'tools', 'about'].indexOf(id) === -1) id = 'settings'; activateTab(id); }); var initial = (location.hash || '#settings').replace('#', ''); if (['settings', 'lqip', 'tools', 'about'].indexOf(initial) === -1) initial = 'settings'; activateTab(initial); } function initCliSuggestions() { var buttons = document.querySelectorAll('.aviflosu-apply-suggestion'); if (!buttons.length) return; buttons.forEach(function (btn) { btn.addEventListener('click', function (e) { e.preventDefault(); var targetId = this.getAttribute('data-target'); var value = this.getAttribute('data-value'); var target = document.getElementById(targetId); if (target) { target.value = value; } }); }); } function initAll() { initTabs(); initCliSuggestions(); function toggleHidden(element, hidden) { if (!element || !element.classList) return; if (hidden) element.classList.add('hidden'); else element.classList.remove('hidden'); } var convertBtn = document.querySelector('#avif-local-support-convert-now'); var stopBtn = document.querySelector('#avif-local-support-stop-convert'); var resultContainer = document.querySelector('#avif-local-support-result'); var spinner = document.querySelector('#avif-local-support-spinner'); var statusEl = document.querySelector('#avif-local-support-status'); var progressEl = document.querySelector('#avif-local-support-convert-progress'); var progressAvifs = document.querySelector('#avif-local-support-progress-avifs'); var progressJpegs = document.querySelector('#avif-local-support-progress-jpegs'); var pollingTimerLocal = null; function stopPolling() { if (pollingTimerLocal) { window.clearInterval(pollingTimerLocal); pollingTimerLocal = null; } toggleHidden(stopBtn, true); toggleHidden(progressEl, true); if (spinner) spinner.classList.remove('is-active'); if (convertBtn) convertBtn.disabled = false; } if (stopBtn && typeof AVIFLocalSupportData !== 'undefined') { stopBtn.addEventListener('click', function (e) { e.preventDefault(); stopBtn.disabled = true; apiFetch({ path: '/aviflosu/v1/stop-convert', method: 'POST' }) .then(function () { if (statusEl) statusEl.textContent = getI18n('avifStopped', 'AVIF generation stopped.'); }) .catch(function () { if (statusEl) statusEl.textContent = getI18n('avifStopFailed', 'Could not stop AVIF generation.'); }) .finally(function () { stopPolling(); stopBtn.disabled = false; }); }); } if (convertBtn && typeof AVIFLocalSupportData !== 'undefined') { convertBtn.addEventListener('click', function (e) { e.preventDefault(); convertBtn.disabled = true; toggleHidden(resultContainer, false); if (spinner) spinner.classList.add('is-active'); if (statusEl) statusEl.textContent = getI18n('avifConverting', 'Generating missing AVIF files...'); toggleHidden(progressEl, true); toggleHidden(stopBtn, false); apiFetch({ path: '/aviflosu/v1/convert-now', method: 'POST' }) .then(function () { toggleHidden(progressEl, false); var prevMissing = null; var unchangedTicks = 0; var startTime = Date.now(); var MAX_UNCHANGED_TICKS = 20; var MAX_DURATION_MS = 10 * 60 * 1000; function updateLocal() { apiFetch({ path: '/aviflosu/v1/scan-missing', method: 'POST' }) .then(function (data) { var total = data.total_jpegs || 0; var avifs = data.existing_avifs || 0; var missing = data.missing_avifs || 0; var totalEl = document.querySelector('#avif-local-support-total-jpegs'); var avifsEl = document.querySelector('#avif-local-support-existing-avifs'); var missingEl = document.querySelector('#avif-local-support-missing-avifs'); if (totalEl) totalEl.textContent = String(total); if (avifsEl) avifsEl.textContent = String(avifs); if (missingEl) missingEl.textContent = String(missing); if (progressAvifs) progressAvifs.textContent = String(avifs); if (progressJpegs) progressJpegs.textContent = String(total); if (missing === 0) { if (statusEl) statusEl.textContent = getI18n('avifComplete', 'AVIF generation complete.'); stopPolling(); } else { if (prevMissing !== null && missing === prevMissing) { unchangedTicks++; } else { unchangedTicks = 0; } prevMissing = missing; if (unchangedTicks >= MAX_UNCHANGED_TICKS || (Date.now() - startTime) > MAX_DURATION_MS) { if (statusEl) statusEl.textContent = getI18n('avifContinuingBackground', 'AVIF generation is continuing in the background.'); stopPolling(); } } }) .catch(function () { }); } if (pollingTimerLocal) window.clearInterval(pollingTimerLocal); pollingTimerLocal = window.setInterval(updateLocal, 1500); updateLocal(); }) .catch(function () { if (statusEl) statusEl.textContent = getI18n('avifFailed', 'AVIF generation failed.'); stopPolling(); }) .finally(function () { }); }); } var deleteBtn = document.querySelector('#avif-local-support-delete-avifs'); if (deleteBtn && typeof AVIFLocalSupportData !== 'undefined') { deleteBtn.addEventListener('click', function (e) { e.preventDefault(); if (!window.confirm(getI18n('confirmDeleteAvifs', 'Delete all AVIF files generated by this plugin?'))) { return; } deleteBtn.disabled = true; toggleHidden(resultContainer, false); if (spinner) spinner.classList.add('is-active'); if (statusEl) statusEl.textContent = getI18n('avifDeleting', 'Deleting AVIF files...'); toggleHidden(progressEl, true); apiFetch({ path: '/aviflosu/v1/delete-all-avifs', method: 'POST' }) .then(function (d) { if (statusEl) { var deletedPrefix = getI18n('avifDeletedPrefix', 'Deleted AVIF files:'); var failedPrefix = getI18n('avifFailedPrefix', 'Failed:'); var deletedText = deletedPrefix + ' ' + String(d.deleted || 0); statusEl.textContent = deletedText + (d.failed ? (', ' + failedPrefix + ' ' + String(d.failed)) : ''); } apiFetch({ path: '/aviflosu/v1/scan-missing', method: 'POST' }) .then(function (data) { var totalEl = document.querySelector('#avif-local-support-total-jpegs'); var avifsEl = document.querySelector('#avif-local-support-existing-avifs'); var missingEl = document.querySelector('#avif-local-support-missing-avifs'); if (totalEl) totalEl.textContent = String(data.total_jpegs || 0); if (avifsEl) avifsEl.textContent = String(data.existing_avifs || 0); if (missingEl) missingEl.textContent = String(data.missing_avifs || 0); }) .catch(function () {  }); }) .catch(function () { if (statusEl) statusEl.textContent = getI18n('avifFailed', 'AVIF generation failed.'); }) .finally(function () { if (spinner) spinner.classList.remove('is-active'); deleteBtn.disabled = false; if (convertBtn) convertBtn.disabled = false; }); }); } var lqipTotalEl = document.querySelector('#aviflosu-thumbhash-total'); var lqipWithEl = document.querySelector('#aviflosu-thumbhash-with'); var lqipWithoutEl = document.querySelector('#aviflosu-thumbhash-without'); var lqipGenerateBtn = document.querySelector('#aviflosu-thumbhash-generate'); var lqipStopBtn = document.querySelector('#aviflosu-thumbhash-stop'); var lqipDeleteBtn = document.querySelector('#aviflosu-thumbhash-delete'); var lqipResultContainer = document.querySelector('#aviflosu-thumbhash-result'); var lqipSpinner = document.querySelector('#aviflosu-thumbhash-spinner'); var lqipStatusEl = document.querySelector('#aviflosu-thumbhash-status'); var lqipProgressEl = document.querySelector('#aviflosu-thumbhash-progress'); var lqipProgressWith = document.querySelector('#aviflosu-thumbhash-progress-with'); var lqipProgressTotal = document.querySelector('#aviflosu-thumbhash-progress-total'); var lqipPollingTimer = null; var lqipStopRequested = false; function loadLqipStats(callback) { apiFetch({ path: '/aviflosu/v1/thumbhash/stats', method: 'GET' }) .then(function (data) { if (lqipTotalEl) lqipTotalEl.textContent = String(data.total || 0); if (lqipWithEl) lqipWithEl.textContent = String(data.with_hash || 0); if (lqipWithoutEl) lqipWithoutEl.textContent = String(data.without_hash || 0); if (callback) callback(data); }) .catch(function () { if (lqipTotalEl) lqipTotalEl.textContent = '-'; if (lqipWithEl) lqipWithEl.textContent = '-'; if (lqipWithoutEl) lqipWithoutEl.textContent = '-'; if (callback) callback({}); }); } function stopLqipPolling() { if (lqipPollingTimer) { window.clearInterval(lqipPollingTimer); lqipPollingTimer = null; } toggleHidden(lqipStopBtn, true); toggleHidden(lqipProgressEl, true); if (lqipSpinner) lqipSpinner.classList.remove('is-active'); if (lqipGenerateBtn) lqipGenerateBtn.disabled = false; if (lqipDeleteBtn) lqipDeleteBtn.disabled = false; lqipStopRequested = false; } if ((lqipTotalEl || lqipWithEl || lqipWithoutEl) && typeof AVIFLocalSupportData !== 'undefined') { loadLqipStats(); } if (lqipStopBtn && typeof AVIFLocalSupportData !== 'undefined') { lqipStopBtn.addEventListener('click', function (e) { e.preventDefault(); lqipStopRequested = true; lqipStopBtn.disabled = true; if (lqipStatusEl) lqipStatusEl.textContent = getI18n('lqipStopping', 'Stopping LQIP generation...'); }); } if (lqipGenerateBtn && typeof AVIFLocalSupportData !== 'undefined') { lqipGenerateBtn.addEventListener('click', function (e) { e.preventDefault(); lqipGenerateBtn.disabled = true; if (lqipDeleteBtn) lqipDeleteBtn.disabled = true; lqipStopRequested = false; toggleHidden(lqipResultContainer, false); if (lqipSpinner) lqipSpinner.classList.add('is-active'); if (lqipStatusEl) lqipStatusEl.textContent = getI18n('lqipGenerating', 'Generating missing LQIPs...'); toggleHidden(lqipProgressEl, false); toggleHidden(lqipStopBtn, false); if (lqipStopBtn) lqipStopBtn.disabled = false; loadLqipStats(function (initialData) { var startWithout = initialData.without_hash || 0; var total = initialData.total || 0; if (lqipProgressTotal) lqipProgressTotal.textContent = String(total); if (lqipProgressWith) lqipProgressWith.textContent = String(initialData.with_hash || 0); apiFetch({ path: '/aviflosu/v1/thumbhash/generate-all', method: 'POST' }) .then(function (data) { if (lqipStatusEl) { lqipStatusEl.textContent = getI18n('lqipComplete', 'LQIP generation complete.') + ' ' + getI18n('lqipGenerated', 'Generated:') + ' ' + (data.generated || 0) + ', ' + getI18n('lqipSkipped', 'Skipped:') + ' ' + (data.skipped || 0) + ', ' + getI18n('lqipFailed', 'Failed:') + ' ' + (data.failed || 0); } stopLqipPolling(); loadLqipStats(); }) .catch(function () { if (lqipStatusEl) lqipStatusEl.textContent = getI18n('lqipFailedShort', 'LQIP generation failed.'); stopLqipPolling(); }); var prevWithout = startWithout; var unchangedTicks = 0; var startTime = Date.now(); var MAX_UNCHANGED_TICKS = 20; var MAX_DURATION_MS = 10 * 60 * 1000; function pollLqipProgress() { if (lqipStopRequested) { if (lqipStatusEl) lqipStatusEl.textContent = getI18n('lqipStopped', 'LQIP generation stopped.'); stopLqipPolling(); loadLqipStats(); return; } loadLqipStats(function (data) { var withHash = data.with_hash || 0; var without = data.without_hash || 0; if (lqipProgressWith) lqipProgressWith.textContent = String(withHash); if (without !== 0) { if (without === prevWithout) { unchangedTicks++; } else { unchangedTicks = 0; } prevWithout = without; if (unchangedTicks >= MAX_UNCHANGED_TICKS || (Date.now() - startTime) > MAX_DURATION_MS) { if (lqipStatusEl) lqipStatusEl.textContent = getI18n('lqipContinuingBackground', 'LQIP generation is continuing in the background...'); stopLqipPolling(); } } }); } if (lqipPollingTimer) window.clearInterval(lqipPollingTimer); lqipPollingTimer = window.setInterval(pollLqipProgress, 1500); pollLqipProgress(); }); }); } if (lqipDeleteBtn && typeof AVIFLocalSupportData !== 'undefined') { lqipDeleteBtn.addEventListener('click', function (e) { e.preventDefault(); if (!window.confirm(getI18n('confirmDeleteLqips', 'Delete all generated LQIPs?'))) { return; } if (lqipGenerateBtn) lqipGenerateBtn.disabled = true; lqipDeleteBtn.disabled = true; toggleHidden(lqipResultContainer, false); if (lqipSpinner) lqipSpinner.classList.add('is-active'); if (lqipStatusEl) lqipStatusEl.textContent = getI18n('lqipDeleting', 'Deleting LQIPs...'); toggleHidden(lqipProgressEl, true); apiFetch({ path: '/aviflosu/v1/thumbhash/delete-all', method: 'POST' }) .then(function (data) { if (lqipStatusEl) { lqipStatusEl.textContent = getI18n('lqipDeleted', 'Deleted LQIPs:') + ' ' + (data.deleted || 0) + ' ' + getI18n('lqipEntries', 'entries'); } if (lqipSpinner) lqipSpinner.classList.remove('is-active'); if (lqipGenerateBtn) lqipGenerateBtn.disabled = false; lqipDeleteBtn.disabled = false; loadLqipStats(); }) .catch(function () { if (lqipStatusEl) lqipStatusEl.textContent = getI18n('lqipFailedShort', 'LQIP generation failed.'); if (lqipSpinner) lqipSpinner.classList.remove('is-active'); if (lqipGenerateBtn) lqipGenerateBtn.disabled = false; lqipDeleteBtn.disabled = false; }); }); } var refreshLogsBtn = document.querySelector('#avif-local-support-refresh-logs'); var copyLogsBtn = document.querySelector('#avif-local-support-copy-logs'); var clearLogsBtn = document.querySelector('#avif-local-support-clear-logs'); var logsSpinner = document.querySelector('#avif-local-support-logs-spinner'); var logsContent = document.querySelector('#avif-local-support-logs-content'); var logsOnlyErrorsToggle = document.querySelector('#avif-local-support-logs-only-errors'); var copyStatus = document.querySelector('#avif-local-support-copy-status'); var copySupportBtn = document.querySelector('#avif-local-support-copy-support'); var copySupportStatus = document.querySelector('#avif-local-support-copy-support-status'); function applyLogsFilter() { if (!logsContent || !logsOnlyErrorsToggle) return; if (!logsContent.parentNode || !document.body.contains(logsContent)) return; var onlyErrors = !!logsOnlyErrorsToggle.checked; var entries = logsContent.querySelectorAll('.avif-log-entry'); for (var i = 0; i < entries.length; i++) { var el = entries[i]; var status = ''; if (el && el.getAttribute) { status = String(el.getAttribute('data-status') || '').toLowerCase(); } if (!status && el && el.classList) { if (el.classList.contains('error')) status = 'error'; else if (el.classList.contains('warning')) status = 'warning'; else if (el.classList.contains('success')) status = 'success'; else if (el.classList.contains('info')) status = 'info'; } var isErrorish = (status === 'error'); el.style.display = (onlyErrors && !isErrorish) ? 'none' : ''; } } if (logsOnlyErrorsToggle) { logsOnlyErrorsToggle.addEventListener('change', applyLogsFilter); setTimeout(applyLogsFilter, 0); } if (copyLogsBtn) { copyLogsBtn.addEventListener('click', function (e) { e.preventDefault(); var contentEl = document.querySelector('#avif-local-support-logs-content'); var text = contentEl ? contentEl.innerText : ''; if (!text) return; if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(text).then(function () { showCopyStatus(); }, function () { fallbackCopy(text); }); } else { fallbackCopy(text); } }); } if (copySupportBtn) { copySupportBtn.addEventListener('click', function (e) { e.preventDefault(); var text = buildSupportDiagnosticsText(); if (!text) return; if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(text).then(function () { showCopySupportStatus(); }, function () { fallbackCopySupport(text); }); } else { fallbackCopySupport(text); } }); } function showStatusElement(element) { if (!element) return; element.classList.remove('hidden'); setTimeout(function () { element.classList.add('hidden'); }, 2000); } function fallbackCopyToClipboard(text, statusElement) { var ta = document.createElement('textarea'); ta.value = text; ta.style.position = 'fixed'; ta.style.left = '-9999px'; document.body.appendChild(ta); ta.focus(); ta.select(); try { document.execCommand('copy'); showStatusElement(statusElement); } catch (e) { } document.body.removeChild(ta); } function fallbackCopy(text) { fallbackCopyToClipboard(text, copyStatus); } function fallbackCopySupport(text) { fallbackCopyToClipboard(text, copySupportStatus); } function showCopyStatus() { showStatusElement(copyStatus); } function showCopySupportStatus() { showStatusElement(copySupportStatus); } function buildSupportDiagnosticsText() { var panel = document.querySelector('.avif-support-panel'); if (!panel) return ''; var clone = panel.cloneNode(true); var details = clone.querySelectorAll('details'); for (var i = 0; i < details.length; i++) { details[i].setAttribute('open', ''); } var kill = clone.querySelectorAll('button, .spinner, script, style'); for (var k = 0; k < kill.length; k++) { if (kill[k] && kill[k].parentNode) kill[k].parentNode.removeChild(kill[k]); } function clean(s) { return String(s || '').replace(/\s+/g, ' ').trim(); } function indent(n) { var out = ''; for (var j = 0; j < n; j++) out += '  '; return out; } var lines = []; function pushLine(s) { s = String(s || ''); if (!s) return; lines.push(s); } function renderTable(tableEl, level) { var rows = tableEl.querySelectorAll('tr'); for (var r = 0; r < rows.length; r++) { var tds = rows[r].querySelectorAll('td'); if (!tds || tds.length < 2) continue; var label = clean(tds[0].textContent || '').replace(/:$/, ''); var value = clean(tds[1].textContent || ''); if (!label && !value) continue; pushLine(indent(level) + '- ' + (label ? (label + ': ') : '') + value); } } function renderList(listEl, level) { var items = listEl.querySelectorAll('li'); for (var r = 0; r < items.length; r++) { var itemText = clean(items[r].textContent || ''); if (!itemText) continue; pushLine(indent(level) + '- ' + itemText); } } function renderPre(preEl, level) { var t = (preEl && preEl.textContent) ? String(preEl.textContent) : ''; t = t.replace(/\r/g, '').trim(); if (!t) return; pushLine(indent(level) + '```'); var preLines = t.split('\n'); for (var i2 = 0; i2 < preLines.length; i2++) { pushLine(indent(level) + preLines[i2]); } pushLine(indent(level) + '```'); } function renderElement(el, level) { if (!el || !el.tagName) return; var tag = el.tagName.toUpperCase(); if (tag === 'H3') { var h = clean(el.textContent || ''); if (h) { if (lines.length) pushLine(''); pushLine('## ' + h); } return; } if (tag === 'DETAILS') { var summaryEl = el.querySelector('summary'); var summary = clean(summaryEl ? summaryEl.textContent : ''); if (summary) { if (lines.length) pushLine(''); pushLine('### ' + summary); } var kids = el.children; for (var d = 0; d < kids.length; d++) { if (kids[d].tagName && kids[d].tagName.toUpperCase() === 'SUMMARY') continue; renderElement(kids[d], level + 1); } return; } if (tag === 'TABLE') { renderTable(el, level); return; } if (tag === 'UL' || tag === 'OL') { renderList(el, level); return; } if (tag === 'PRE') { renderPre(el, level); return; } if (tag === 'P') { var p = clean(el.textContent || ''); if (p) { pushLine(indent(level) + p); } return; } var children = el.children; for (var c = 0; c < children.length; c++) { renderElement(children[c], level); } } var rootChildren = clone.children; for (var rc = 0; rc < rootChildren.length; rc++) { renderElement(rootChildren[rc], 0); } var compact = []; for (var li = 0; li < lines.length; li++) { var cur = lines[li]; var prev = compact.length ? compact[compact.length - 1] : null; if (cur === '' && prev === '') continue; compact.push(cur); } var body = compact.join('\n').trim(); if (!body) return ''; var header = [ 'AVIF Local Support — Server Support diagnostics', 'Generated: ' + (new Date()).toISOString(), 'Page: ' + (window.location && window.location.href ? window.location.href : ''), '' ].join('\n'); return header + body; } if (refreshLogsBtn && typeof AVIFLocalSupportData !== 'undefined') { refreshLogsBtn.addEventListener('click', function (e) { e.preventDefault(); if (logsSpinner) logsSpinner.classList.add('is-active'); apiFetch({ path: '/aviflosu/v1/logs', method: 'GET' }) .then(function (json) { if (json && json.content && logsContent) { logsContent.innerHTML = json.content; applyLogsFilter(); } }) .catch(function () { if (logsContent) { logsContent.innerHTML = '<p class="description avif-error-text">' + getI18n('logsRefreshFailed', 'Could not refresh logs. Please try again.') + '</p>'; } }) .finally(function () { if (logsSpinner) logsSpinner.classList.remove('is-active'); }); }); } if (clearLogsBtn && typeof AVIFLocalSupportData !== 'undefined') { clearLogsBtn.addEventListener('click', function (e) { e.preventDefault(); if (!window.confirm(getI18n('confirmClearLogs', 'Clear all logs?'))) { return; } if (logsSpinner) logsSpinner.classList.add('is-active'); apiFetch({ path: '/aviflosu/v1/logs/clear', method: 'POST' }) .then(function () { if (logsContent) { logsContent.innerHTML = '<p class="description">' + getI18n('logsNone', 'No logs available.') + '</p>'; } }) .catch(function () { if (logsContent) { logsContent.innerHTML = '<p class="description avif-error-text">' + getI18n('logsClearFailed', 'Could not clear logs. Please try again.') + '</p>'; } }) .finally(function () { if (logsSpinner) logsSpinner.classList.remove('is-active'); }); }); } var runTestBtn = document.querySelector('#avif-local-support-run-magick-test'); var runTestSpinner = document.querySelector('#avif-local-support-magick-test-spinner'); var runTestStatus = document.querySelector('#avif-local-support-magick-test-status'); var runTestOutput = document.querySelector('#avif-local-support-magick-test-output'); if (runTestBtn && typeof AVIFLocalSupportData !== 'undefined') { runTestBtn.addEventListener('click', function (e) { e.preventDefault(); runTestBtn.disabled = true; if (runTestSpinner) runTestSpinner.classList.add('is-active'); if (runTestStatus) runTestStatus.textContent = getI18n('magickRunning', 'Running ImageMagick check...'); if (runTestOutput) { toggleHidden(runTestOutput, true); runTestOutput.textContent = ''; } apiFetch({ path: '/aviflosu/v1/magick-test', method: 'POST' }) .then(function (data) { if (!data) return; if (runTestStatus) runTestStatus.textContent = getI18n('magickExitCode', 'Exit code') + ' ' + String(data.code); var lines = []; if (data.selected_path) { lines.push(getI18n('magickSelectedBinary', 'Selected binary:') + ' ' + String(data.selected_path) + (data.auto_selected ? (' ' + getI18n('magickAuto', '(auto)')) : '')); } if (data.define_strategy && data.define_strategy.namespace) { var s = data.define_strategy; lines.push( getI18n('magickDefineStrategy', 'Define strategy:') + ' ' + String(s.namespace) + ' (lossless=' + String(!!s.supports_lossless) + ', chroma=' + String(!!s.supports_chroma) + ', -depth=' + String(!!s.supports_depth) + ', bit-depth-define=' + String(!!s.supports_bit_depth_define) + ')' ); } if (lines.length) { lines.push(''); } lines.push(String(data.output || '')); if (data.hint) { lines.push(''); lines.push(getI18n('magickHint', 'Hint:') + ' ' + String(data.hint)); } var text = lines.join('\n'); if (runTestOutput) { runTestOutput.textContent = text; toggleHidden(runTestOutput, false); } }) .catch(function (err) { if (runTestStatus) runTestStatus.textContent = (err && err.message) ? String(err.message) : getI18n('magickFailed', 'ImageMagick check failed.'); }) .finally(function () { if (runTestSpinner) runTestSpinner.classList.remove('is-active'); runTestBtn.disabled = false; }); }); } var testForm = document.querySelector('#avif-local-support-test-form'); var testFile = document.querySelector('#avif-local-support-test-file'); var testSubmit = document.querySelector('#avif-local-support-test-submit'); var testSpinner = document.querySelector('#avif-local-support-test-spinner'); var testStatus = document.querySelector('#avif-local-support-test-status'); var testResults = document.querySelector('#avif-local-support-test-results'); if (testForm && testFile && testSubmit && typeof AVIFLocalSupportData !== 'undefined') { testForm.addEventListener('submit', function (e) { e.preventDefault(); var file = testFile.files[0]; if (!file) return; testSubmit.disabled = true; if (testSpinner) testSpinner.classList.add('is-active'); if (testStatus) testStatus.textContent = getI18n('testUploading', 'Uploading JPEG test file...'); if (testResults) testResults.innerHTML = ''; function pollTestStatus(attachmentId, targetIndex) { apiFetch({ path: '/aviflosu/v1/upload-test-status', method: 'POST', body: JSON.stringify({ attachment_id: attachmentId, target_index: targetIndex }), headers: { 'Content-Type': 'application/json' } }) .then(function (json) { if (json && json.sizes) { renderTestResultsTable(json, testResults); if (testStatus) { testStatus.textContent = getI18n('testConverting', 'Converting test sizes...'); } if (!json.complete) { pollTestStatus(attachmentId, json.next_index); } else { if (testStatus) testStatus.textContent = getI18n('testDone', 'Test conversion complete.'); if (testSpinner) testSpinner.classList.remove('is-active'); testSubmit.disabled = false; } } else { if (testStatus) testStatus.textContent = getI18n('testStatusFailed', 'Unable to load test conversion status.'); if (testSpinner) testSpinner.classList.remove('is-active'); testSubmit.disabled = false; } }) .catch(function (err) { if (testStatus) testStatus.textContent = getI18n('testErrorPrefix', 'Error:') + ' ' + (err.message || getI18n('testUnknown', 'Unknown error')); if (testSpinner) testSpinner.classList.remove('is-active'); testSubmit.disabled = false; }); } var formData = new FormData(); formData.append('avif_local_support_test_file', file); apiFetch({ path: '/aviflosu/v1/upload-test', method: 'POST', body: formData }) .then(function (json) { if (json && json.attachment_id) { renderTestResultsTable(json, testResults); if (testStatus) testStatus.textContent = getI18n('testConverting', 'Converting test sizes...'); pollTestStatus(json.attachment_id, 0); } else { if (testStatus) testStatus.textContent = getI18n('testUploadFailed', 'Test upload failed.'); if (testSpinner) testSpinner.classList.remove('is-active'); testSubmit.disabled = false; } }) .catch(function (err) { var msg = (err && err.message) ? String(err.message) : getI18n('testUnknown', 'Unknown error'); if (msg.toLowerCase().indexOf('json') !== -1 || msg.toLowerCase().indexOf('timeout') !== -1 || msg.toLowerCase().indexOf('fetch') !== -1) { msg = getI18n('testUploadTimeout', 'Upload timed out or failed. Check logs.'); } if (testStatus) testStatus.textContent = msg; if (testSpinner) testSpinner.classList.remove('is-active'); testSubmit.disabled = false; }); }); } var engineRadios = document.querySelectorAll('input[name="aviflosu_engine_mode"]'); var cliOptionsDiv = document.querySelector('#aviflosu_cli_options'); var subsamplingField = document.querySelector('#aviflosu_subsampling'); var bitDepthField = document.querySelector('#aviflosu_bit_depth'); function getContainer(el) { if (!el) return null; var p = el.closest('tr'); return p ? p : el.parentElement; } function updateEngineVisibility() { var mode = 'auto'; for (var i = 0; i < engineRadios.length; i++) { if (engineRadios[i].checked) { mode = engineRadios[i].value; break; } } var cliContainer = getContainer(cliOptionsDiv); if (cliContainer) { cliContainer.style.display = (mode === 'auto' || mode === 'cli') ? '' : 'none'; } var showAdvanced = (mode === 'auto' || mode === 'cli' || mode === 'imagick'); var subContainer = getContainer(subsamplingField); if (subContainer) { subContainer.style.display = showAdvanced ? '' : 'none'; } var bitContainer = getContainer(bitDepthField); if (bitContainer) { bitContainer.style.display = showAdvanced ? '' : 'none'; } } if (engineRadios.length > 0) { for (var i = 0; i < engineRadios.length; i++) { engineRadios[i].addEventListener('change', updateEngineVisibility); } updateEngineVisibility(); } } function formatBytes(bytes, decimals) { if (bytes === 0) return '0 B'; var k = 1024; var dm = decimals < 0 ? 0 : decimals; var sizes = ['B', 'KB', 'MB', 'GB', 'TB']; var i = Math.floor(Math.log(bytes) / Math.log(k)); return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i]; } function renderTestResultsTable(data, container) { var html = '<p><strong>' + getI18n('testResultsForAttachment', 'Test results for attachment:') + '</strong> <a href="' + (data.edit_link || '#') + '" target="_blank">' + (data.title || data.attachment_id) + '</a></p>'; html += '<table class="widefat striped"><thead><tr>' + '<th>' + getI18n('testSize', 'Size') + '</th>' + '<th>' + getI18n('testDimensions', 'Dimensions') + '</th>' + '<th>' + getI18n('testJpeg', 'JPEG') + '</th>' + '<th>' + getI18n('testJpegSize', 'JPEG size') + '</th>' + '<th>' + getI18n('testAvif', 'AVIF') + '</th>' + '<th>' + getI18n('testAvifSize', 'AVIF size') + '</th>' + '<th>' + getI18n('testStatus', 'Status') + '</th>' + '</tr></thead><tbody>'; if (data.sizes && data.sizes.length) { data.sizes.forEach(function (row) { var dims = (row.width && row.height) ? (row.width + '×' + row.height) : ''; var viewLabel = getI18n('testView', 'View'); var jpegLink = row.jpeg_url ? '<a href="' + row.jpeg_url + '" target="_blank">' + viewLabel + '</a>' : '-'; var avifLink = (row.status === 'success' && row.avif_url) ? '<a href="' + row.avif_url + '" target="_blank">' + viewLabel + '</a>' : '-'; var status; switch (row.status) { case 'success': status = '<span class="avif-status-success-text">' + getI18n('testConverted', 'Converted') + '</span>'; break; case 'failure': status = '<span class="avif-status-error">' + getI18n('testFailed', 'Failed') + '</span>'; if (row.error) { var errText = String(row.error).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); status += '<br><span class="avif-status-error-note">' + errText + '</span>'; } break; case 'processing': status = '<span class="spinner is-active avif-spinner-inline"></span> ' + getI18n('testProcessing', 'Processing...'); break; default: status = getI18n('testPending', 'Pending'); } html += '<tr>' + '<td>' + (row.name || '') + '</td>' + '<td>' + dims + '</td>' + '<td>' + jpegLink + '</td>' + '<td>' + formatBytes(row.jpeg_size || 0, 2) + '</td>' + '<td>' + avifLink + '</td>' + '<td>' + formatBytes(row.avif_size || 0, 2) + '</td>' + '<td>' + status + '</td>' + '</tr>'; }); } else { html += '<tr><td colspan="7">' + getI18n('testNoSizesFound', 'No sizes found.') + '</td></tr>'; } html += '</tbody></table>'; container.innerHTML = html; } if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', initAll); } else { initAll(); } })();
