"use strict";!function(){function t(t){return document.querySelector(t)}var e=!1;function n(t){return e||(e=!0,"undefined"!=typeof AVIFLocalSupportData&&window.wp&&wp.apiFetch&&(AVIFLocalSupportData.restUrl&&wp.apiFetch.use(wp.apiFetch.createRootURLMiddleware(AVIFLocalSupportData.restUrl)),AVIFLocalSupportData.restNonce&&wp.apiFetch.use(wp.apiFetch.createNonceMiddleware(AVIFLocalSupportData.restNonce)))),window.wp&&wp.apiFetch?wp.apiFetch(t):Promise.reject(new Error("wp.apiFetch unavailable"))}function a(e){["settings","lqip","tools","about"].forEach(function(n){var a=t("#avif-local-support-tab-link-"+n),o=t("#avif-local-support-tab-"+n);a&&o&&(n===e?(a.classList.add("nav-tab-active"),o.classList.add("active")):(a.classList.remove("nav-tab-active"),o.classList.remove("active")))})}function o(){var t;(t=".nav-tab-wrapper a",Array.prototype.slice.call(document.querySelectorAll(t))).forEach(function(t){t.addEventListener("click",function(t){t.preventDefault();var e=(this.getAttribute("href")||"").replace("#","");if(e){a(e);try{history.replaceState(null,"","#"+e)}catch(t){}}})}),window.addEventListener("hashchange",function(){var t=(location.hash||"#settings").replace("#","");-1===["settings","lqip","tools","about"].indexOf(t)&&(t="settings"),a(t)});var e=(location.hash||"#settings").replace("#","");-1===["settings","lqip","tools","about"].indexOf(e)&&(e="settings"),a(e)}function i(){var e=t("#avif-local-support-rescan");e&&"undefined"!=typeof AVIFLocalSupportData&&e.addEventListener("click",function(){var e,a,o;e=t("#avif-local-support-total-jpegs"),a=t("#avif-local-support-existing-avifs"),o=t("#avif-local-support-missing-avifs"),e&&a&&o&&(e.innerHTML=a.innerHTML=o.innerHTML='<span class="spinner is-active"></span>'),n({path:"/aviflosu/v1/scan-missing",method:"POST"}).then(function(e){var n=t("#avif-local-support-total-jpegs"),a=t("#avif-local-support-existing-avifs"),o=t("#avif-local-support-missing-avifs");n&&a&&o&&(n.textContent=String(e.total_jpegs||0),a.textContent=String(e.existing_avifs||0),o.textContent=String(e.missing_avifs||0))}).catch(function(){var e=t("#avif-local-support-total-jpegs"),n=t("#avif-local-support-existing-avifs"),a=t("#avif-local-support-missing-avifs");e&&n&&a&&(e.textContent=n.textContent=a.textContent="-")})})}function s(){var t;o(),i(),(t=document.querySelectorAll(".aviflosu-apply-suggestion")).length&&t.forEach(function(t){t.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("data-target"),n=this.getAttribute("data-value"),a=document.getElementById(e);a&&(a.value=n)})});var e=document.querySelector("#avif-local-support-convert-now"),a=document.querySelector("#avif-local-support-stop-convert"),s=document.querySelector("#avif-local-support-result"),r=document.querySelector("#avif-local-support-spinner"),c=document.querySelector("#avif-local-support-status"),u=document.querySelector("#avif-local-support-convert-progress"),p=document.querySelector("#avif-local-support-progress-avifs"),d=document.querySelector("#avif-local-support-progress-jpegs"),f=null;function v(){f&&(window.clearInterval(f),f=null),a&&(a.style.display="none"),u&&(u.style.display="none"),r&&r.classList.remove("is-active"),e&&(e.disabled=!1)}a&&"undefined"!=typeof AVIFLocalSupportData&&a.addEventListener("click",function(t){t.preventDefault(),a.disabled=!0,n({path:"/aviflosu/v1/stop-convert",method:"POST"}).then(function(){c&&(c.textContent="Stopped")}).catch(function(){c&&(c.textContent="Stop failed")}).finally(function(){v(),a.disabled=!1})}),e&&"undefined"!=typeof AVIFLocalSupportData&&e.addEventListener("click",function(t){t.preventDefault(),e.disabled=!0,s&&(s.style.display="block"),r&&r.classList.add("is-active"),c&&(c.textContent="Converting..."),u&&(u.style.display="none"),a&&(a.style.display=""),n({path:"/aviflosu/v1/convert-now",method:"POST"}).then(function(){u&&(u.style.display="");var t=null,e=0,a=Date.now();function o(){n({path:"/aviflosu/v1/scan-missing",method:"POST"}).then(function(n){var o=n.total_jpegs||0,i=n.existing_avifs||0,s=n.missing_avifs||0,r=document.querySelector("#avif-local-support-total-jpegs"),l=document.querySelector("#avif-local-support-existing-avifs"),u=document.querySelector("#avif-local-support-missing-avifs");r&&(r.textContent=String(o)),l&&(l.textContent=String(i)),u&&(u.textContent=String(s)),p&&(p.textContent=String(i)),d&&(d.textContent=String(o)),0===s?(c&&(c.textContent="Complete!"),v()):(null!==t&&s===t?e++:e=0,t=s,(e>=20||Date.now()-a>6e5)&&(c&&(c.textContent="Continuing in background..."),v()))}).catch(function(){})}f&&window.clearInterval(f),f=window.setInterval(o,1500),o()}).catch(function(){c&&(c.textContent="Failed"),v()}).finally(function(){})});var g=document.querySelector("#avif-local-support-delete-avifs");g&&"undefined"!=typeof AVIFLocalSupportData&&g.addEventListener("click",function(t){t.preventDefault(),g.disabled=!0,s&&(s.style.display="block"),r&&r.classList.add("is-active"),c&&(c.textContent="Deleting..."),u&&(u.style.display="none"),n({path:"/aviflosu/v1/delete-all-avifs",method:"POST"}).then(function(t){c&&(c.textContent="Deleted "+String(t.deleted||0)+(t.failed?", failed "+String(t.failed):"")),n({path:"/aviflosu/v1/scan-missing",method:"POST"}).then(function(t){var e=document.querySelector("#avif-local-support-total-jpegs"),n=document.querySelector("#avif-local-support-existing-avifs"),a=document.querySelector("#avif-local-support-missing-avifs");e&&(e.textContent=String(t.total_jpegs||0)),n&&(n.textContent=String(t.existing_avifs||0)),a&&(a.textContent=String(t.missing_avifs||0))}).catch(function(){})}).catch(function(){c&&(c.textContent="Failed")}).finally(function(){r&&r.classList.remove("is-active"),g.disabled=!1,e&&(e.disabled=!1)})});var h=document.querySelector("#avif-local-support-refresh-logs"),m=document.querySelector("#avif-local-support-copy-logs"),y=document.querySelector("#avif-local-support-clear-logs"),S=document.querySelector("#avif-local-support-logs-spinner"),x=document.querySelector("#avif-local-support-logs-content"),L=document.querySelector("#avif-local-support-logs-only-errors"),b=document.querySelector("#avif-local-support-copy-status"),C=document.querySelector("#avif-local-support-copy-support"),w=document.querySelector("#avif-local-support-copy-support-status");function q(){if(x&&L&&x.parentNode&&document.body.contains(x))for(var t=!!L.checked,e=x.querySelectorAll(".avif-log-entry"),n=0;n<e.length;n++){var a=e[n],o="";a&&a.getAttribute&&(o=String(a.getAttribute("data-status")||"").toLowerCase()),!o&&a&&a.classList&&(a.classList.contains("error")?o="error":a.classList.contains("warning")?o="warning":a.classList.contains("success")?o="success":a.classList.contains("info")&&(o="info"));var i="error"===o;a.style.display=t&&!i?"none":""}}function _(t){t&&(t.style.display="inline",setTimeout(function(){t.style.display="none"},2e3))}function A(t,e){var n=document.createElement("textarea");n.value=t,n.style.position="fixed",n.style.left="-9999px",document.body.appendChild(n),n.focus(),n.select();try{document.execCommand("copy"),_(e)}catch(t){}document.body.removeChild(n)}function D(t){A(t,b)}function F(t){A(t,w)}L&&(L.addEventListener("change",q),setTimeout(q,0)),m&&m.addEventListener("click",function(t){t.preventDefault();var e=document.querySelector("#avif-local-support-logs-content"),n=e?e.innerText:"";n&&(navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(n).then(function(){_(b)},function(){D(n)}):D(n))}),C&&C.addEventListener("click",function(t){t.preventDefault();var e=function(){var t=document.querySelector(".avif-support-panel");if(!t)return"";for(var e=t.cloneNode(!0),n=e.querySelectorAll("details"),a=0;a<n.length;a++)n[a].setAttribute("open","");for(var o=e.querySelectorAll("button, .spinner, script, style"),i=0;i<o.length;i++)o[i]&&o[i].parentNode&&o[i].parentNode.removeChild(o[i]);function s(t){return String(t||"").replace(/\s+/g," ").trim()}function r(t){for(var e="",n=0;n<t;n++)e+="  ";return e}var l=[];function c(t){(t=String(t||""))&&l.push(t)}function u(t,e){for(var n=t.querySelectorAll("tr"),a=0;a<n.length;a++){var o=n[a].querySelectorAll("td");if(o&&!(o.length<2)){var i=s(o[0].textContent||"").replace(/:$/,""),l=s(o[1].textContent||"");(i||l)&&c(r(e)+"- "+(i?i+": ":"")+l)}}}function p(t,e){for(var n=t.querySelectorAll("li"),a=0;a<n.length;a++){var o=s(n[a].textContent||"");o&&c(r(e)+"- "+o)}}function d(t,e){var n=t&&t.textContent?String(t.textContent):"";if(n=n.replace(/\r/g,"").trim()){c(r(e)+"```");for(var a=n.split("\n"),o=0;o<a.length;o++)c(r(e)+a[o]);c(r(e)+"```")}}function f(t,e){if(t&&t.tagName){var n=t.tagName.toUpperCase();if("H3"!==n)if("DETAILS"!==n)if("TABLE"!==n)if("UL"!==n&&"OL"!==n)if("PRE"!==n)if("P"!==n)for(var a=t.children,o=0;o<a.length;o++)f(a[o],e);else{var i=s(t.textContent||"");i&&c(r(e)+i)}else d(t,e);else p(t,e);else u(t,e);else{var v=t.querySelector("summary"),g=s(v?v.textContent:"");g&&(l.length&&c(""),c("### "+g));for(var h=t.children,m=0;m<h.length;m++)h[m].tagName&&"SUMMARY"===h[m].tagName.toUpperCase()||f(h[m],e+1)}else{var y=s(t.textContent||"");y&&(l.length&&c(""),c("## "+y))}}}for(var v=e.children,g=0;g<v.length;g++)f(v[g],0);for(var h=[],m=0;m<l.length;m++){var y=l[m],S=h.length?h[h.length-1]:null;""===y&&""===S||h.push(y)}var x=h.join("\n").trim();return x?["AVIF Local Support — Server Support diagnostics","Generated: "+(new Date).toISOString(),"Page: "+(window.location&&window.location.href?window.location.href:""),""].join("\n")+x:""}();e&&(navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(e).then(function(){_(w)},function(){F(e)}):F(e))}),h&&"undefined"!=typeof AVIFLocalSupportData&&h.addEventListener("click",function(t){t.preventDefault(),S&&S.classList.add("is-active"),n({path:"/aviflosu/v1/logs",method:"GET"}).then(function(t){t&&t.content&&x&&(x.innerHTML=t.content,q())}).catch(function(){x&&(x.innerHTML='<p class="description" style="color:#dc3232;">Failed to refresh logs. Please try again.</p>')}).finally(function(){S&&S.classList.remove("is-active")})}),y&&"undefined"!=typeof AVIFLocalSupportData&&y.addEventListener("click",function(t){t.preventDefault(),S&&S.classList.add("is-active"),n({path:"/aviflosu/v1/logs/clear",method:"POST"}).then(function(){x&&(x.innerHTML='<p class="description">No logs available.</p>')}).catch(function(){alert("Failed to clear logs. Please try again.")}).finally(function(){S&&S.classList.remove("is-active")})});var k=document.querySelector("#avif-local-support-run-magick-test"),E=document.querySelector("#avif-local-support-magick-test-spinner"),T=document.querySelector("#avif-local-support-magick-test-status"),I=document.querySelector("#avif-local-support-magick-test-output");k&&"undefined"!=typeof AVIFLocalSupportData&&k.addEventListener("click",function(t){t.preventDefault(),k.disabled=!0,E&&E.classList.add("is-active"),T&&(T.textContent="Running…"),I&&(I.style.display="none",I.textContent=""),n({path:"/aviflosu/v1/magick-test",method:"POST"}).then(function(t){if(t){T&&(T.textContent="Exit code "+String(t.code));var e=[];if(t.selected_path&&e.push("Selected binary: "+String(t.selected_path)+(t.auto_selected?" (auto)":"")),t.define_strategy&&t.define_strategy.namespace){var n=t.define_strategy;e.push("Define strategy: "+String(n.namespace)+" (lossless="+String(!!n.supports_lossless)+", chroma="+String(!!n.supports_chroma)+", -depth="+String(!!n.supports_depth)+", bit-depth-define="+String(!!n.supports_bit_depth_define)+")")}e.length&&e.push(""),e.push(String(t.output||"")),t.hint&&(e.push(""),e.push("Hint: "+String(t.hint)));var a=e.join("\n");I&&(I.textContent=a,I.style.display="")}}).catch(function(t){T&&(T.textContent=t&&t.message?String(t.message):"Failed")}).finally(function(){E&&E.classList.remove("is-active"),k.disabled=!1})});var P=document.querySelector("#avif-local-support-test-form"),O=document.querySelector("#avif-local-support-test-file"),j=document.querySelector("#avif-local-support-test-submit"),M=document.querySelector("#avif-local-support-test-spinner"),V=document.querySelector("#avif-local-support-test-status"),N=document.querySelector("#avif-local-support-test-results");P&&O&&j&&"undefined"!=typeof AVIFLocalSupportData&&P.addEventListener("submit",function(t){t.preventDefault();var e=O.files[0];if(e){j.disabled=!0,M&&M.classList.add("is-active"),V&&(V.textContent="Uploading..."),N&&(N.innerHTML="");var a=new FormData;a.append("avif_local_support_test_file",e),n({path:"/aviflosu/v1/upload-test",method:"POST",body:a}).then(function(t){t&&t.attachment_id?(l(t,N),V&&(V.textContent="Converting..."),o(t.attachment_id,0)):(V&&(V.textContent="Upload failed"),M&&M.classList.remove("is-active"),j.disabled=!1)}).catch(function(t){var e=t&&t.message?String(t.message):"Error";-1===e.toLowerCase().indexOf("json")&&-1===e.toLowerCase().indexOf("timeout")&&-1===e.toLowerCase().indexOf("fetch")||(e="Upload timed out or failed. Check logs."),V&&(V.textContent=e),M&&M.classList.remove("is-active"),j.disabled=!1})}function o(t,e){n({path:"/aviflosu/v1/upload-test-status",method:"POST",body:JSON.stringify({attachment_id:t,target_index:e}),headers:{"Content-Type":"application/json"}}).then(function(e){e&&e.sizes?(l(e,N),V&&(V.textContent="Converting..."),e.complete?(V&&(V.textContent="Done"),M&&M.classList.remove("is-active"),j.disabled=!1):o(t,e.next_index)):(V&&(V.textContent="Failed to get status"),M&&M.classList.remove("is-active"),j.disabled=!1)}).catch(function(t){V&&(V.textContent="Error: "+(t.message||"Unknown")),M&&M.classList.remove("is-active"),j.disabled=!1})}});var z=document.querySelectorAll('input[name="aviflosu_engine_mode"]'),U=document.querySelector("#aviflosu_cli_options"),H=document.querySelector("#aviflosu_subsampling"),B=document.querySelector("#aviflosu_bit_depth");function G(t){if(!t)return null;var e=t.closest("tr");return e||t.parentElement}function R(){for(var t="auto",e=0;e<z.length;e++)if(z[e].checked){t=z[e].value;break}var n=G(U);n&&(n.style.display="auto"===t||"cli"===t?"":"none");var a="auto"===t||"cli"===t||"imagick"===t,o=G(H);o&&(o.style.display=a?"":"none");var i=G(B);i&&(i.style.display=a?"":"none")}if(z.length>0){for(var J=0;J<z.length;J++)z[J].addEventListener("change",R);R()}}function r(t,e){if(0===t)return"0 B";var n=e<0?0:e,a=Math.floor(Math.log(t)/Math.log(1024));return parseFloat((t/Math.pow(1024,a)).toFixed(n))+" "+["B","KB","MB","GB","TB"][a]}function l(t,e){var n='<p><strong>Test results for attachment:</strong> <a href="'+(t.edit_link||"#")+'" target="_blank">'+(t.title||t.attachment_id)+"</a></p>";n+='<table class="widefat striped" style="max-width:960px"><thead><tr><th>Size</th><th>Dimensions</th><th>JPEG</th><th>JPEG size</th><th>AVIF</th><th>AVIF size</th><th>Status</th></tr></thead><tbody>',t.sizes&&t.sizes.length?t.sizes.forEach(function(t){var e,a=t.width&&t.height?t.width+"×"+t.height:"",o=t.jpeg_url?'<a href="'+t.jpeg_url+'" target="_blank">View</a>':"-",i="success"===t.status&&t.avif_url?'<a href="'+t.avif_url+'" target="_blank">View</a>':"-";switch(t.status){case"success":e='<span style="color:#00a32a;font-weight:bold;">Converted</span>';break;case"failure":if(e='<span style="color:#d63638;font-weight:bold;">Failed</span>',t.error)e+='<br><span style="font-size:11px;color:#d63638;">'+String(t.error).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")+"</span>";break;case"processing":e='<span class="spinner is-active" style="float:none;margin:0 4px -2px 0;"></span> Processing...';break;default:e="Pending"}n+="<tr><td>"+(t.name||"")+"</td><td>"+a+"</td><td>"+o+"</td><td>"+r(t.jpeg_size||0,2)+"</td><td>"+i+"</td><td>"+r(t.avif_size||0,2)+"</td><td>"+e+"</td></tr>"}):n+='<tr><td colspan="7">No sizes found.</td></tr>',n+="</tbody></table>",e.innerHTML=n}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",s):s()}();